---
title: "Extract records of interest from the EBI GWAS Catalog"
output:
  html_notebook: default
  html_document:
    df_print: paged
---
```{r setup, echo=FALSE}
library(gwascat)
library(dplyr)
library(stringr)
library(ggplot2)

# Define project directories
projroot <- rprojroot::find_rstudio_root_file()
funcdir <- file.path(projroot, "functions")
datadir <- file.path(projroot, "data")

# Get live GWAS data
source(file.path(funcdir, "refresh_gwas_dataset.R"), chdir = TRUE)
```

# GWAS Catalog Dataset
```{r}
gwas_data
```

## Structure
The GWAS Catalog is a large dataset (134,314x38) with records representing disease associated SNPs identified through Genome Wide Association Studies. Each table row represents a Single Nucleotide Polymorphism associated with a given disease trait. Lots of papers report multiple SNPs, so each paper tends to be replicated in a many-to-one table relationship style.

Each record contains information about the SNP of interest:

* Details of the publication in which it is reported
    + Study Title,
    + PubMed Id,    + Date Published,
    + First Author,
    + Journal me,
    + NCBI Link,
* Details of the condition it is associated with 
     + DISEASETRAIT, 
    + Risk allele, [SNP_ ID]-[Risk_Associated_Nucleotide]
    + Associated Risk (Odds Ratio or Beta coefficient, including p-value & 95% CI)
    + Sample Size, etc...
* Details of the. genetic locus at which it resides 
    + SNP ID,
    + Chromosome,
    + Genomic Region, (p/q notation),
    + Chromosomal Position, (Nucleotide index),
    + Related Genes,
    + Variant Context, (SNP Functional class - exon/missense/non-coding/etc)
    + Platform (Genotyping platformI manufacturer used in Stage 1)
    
### Reducing the dataset
First we need to reduce the full GWAS Catalog [data dictionary here](https://www.ebi.ac.uk/gwas/d.  ocs/fileheaders) down to include only cancer related records.

Once this is done, each record will be assessed and categorised based on a thematic analysis of the study title.

The intent here is to isolate only those records that have some kind of relevance to cancer. This will be done by filtering for cancer-like keywords in the DISEASE.TRAIT field.

#### Positive RegEx matches (include)
* "cancer"
    + Match the pattern "cancer"
* "oma[^\\w]"
    + Match the pattern "oma" only where it is not followed by a "word character" (i.e. ASCII letter, digit or underscore). Effectively matches any word with the suffix "oma"
    + Included: Melan**oma**, Carcin**oma**, etc...
    + Not included: Chr**oma**tosis, Bi**oma**rker, S**oma**tic 
    + **NOTE:** *Need to validate that no cancer records are excluded*

#### Negative RegEx matches (exclude)
* "glaucoma"
    + Exclude the pattern "glaucoma"
    + Glaucoma is a degenerative eye syndrome characterised by vision loss as a result of damage to the optic nerve (not cancer).
* "tripanosoma"
    + Exclude the pattern "tripanosoma"
    + Tripanosoma is a genus of parasitic protozoa (not cancer).
* "hematoma"
    + Exclude the pattern "hematoma"
    + A hematoma is an abnormal collection of blood  external to the circulatory system (a more serious form of bruise) caused by the leakage of blood from a *large* blood vessel (not cancer).

```{r, message=FALSE}
source(file.path(funcdir, "select_gwas_cancer.R"))
extract_cancer_data(gwas_data)
```

Now we should have a set of records that only include SNPs that are associated with traits related to cancer.

#### Describe Catalog - Pre Clustering

#### Thematic Analysis
Although we've reduced our dataset to cancer-related records, this includes a wide spectrum of traits.

For example, there are SNPs that predict cancer risk (these are the ones we're primarily looking for), but these are often in the context of a particular disease type/subtype or causative characteristic. It is important to stratify these.

In addition, there are SNPs that predict prognosis, treatment response, adverse effects, confounding interactions, etc. Suffice to say that there are many more considerations to make before we begin to analyse the disease associations.

This dataset is again reduced, this time to unique records. This dataframe is used for classification via title analysis (K-Means Clustering)

```{r}
# Prepare titles for classification

cancer_classes <- gwas_cancer_data %>%
	dplyr::select(PUBMEDID, DISEASE.TRAIT) %>% 
	mutate(
	    traits = tolower(DISEASE.TRAIT),                                 # all lowercase,
	    bile_duct =          if_else(str_detect(traits, "cholangio"), TRUE, FALSE),
	    bladder =            if_else(str_detect(traits, "(^| )bladder"), TRUE, FALSE),
	    blood =              if_else(str_detect(traits, "b-cell|myeloma"), TRUE, FALSE),
	    brain =              if_else(str_detect(traits, "glio"), TRUE, FALSE),
	    breast =             if_else(str_detect(traits, "breast"), TRUE, FALSE),
	    cervical =           if_else(str_detect(traits, "cervical"), TRUE, FALSE),
	    colorectal =         if_else(str_detect(traits, "colo"), TRUE, FALSE),
	    endometrial =        if_else(str_detect(traits, "endometri"), TRUE, FALSE),
	    esophageal =         if_else(str_detect(traits, "esophageal"), TRUE, FALSE),
	    gallbladder =        if_else(str_detect(traits, "gall"), TRUE, FALSE),
	    gastric =            if_else(str_detect(traits, "gastric"), TRUE, FALSE),
	    head_neck =          if_else(str_detect(traits, "oral cavity|oropharynx|nasoph"), TRUE, FALSE),
	    kidney =             if_else(str_detect(traits, "renal"), TRUE, FALSE),
	    liver =              if_else(str_detect(traits, "hepato"), TRUE, FALSE),
	    lung =               if_else(str_detect(traits, "lung"), TRUE, FALSE),
	    lymphoma =           if_else(str_detect(traits, "lymph"), TRUE, FALSE),
	    neuroblastoma =      if_else(str_detect(traits, "neuroblastoma"), TRUE, FALSE),
	    ovarian =            if_else(str_detect(traits, "ovarian"), TRUE, FALSE),
	    pancreatic =         if_else(str_detect(traits, "pancrea"), TRUE, FALSE),
	    prostate =           if_else(str_detect(traits, "prostate"), TRUE, FALSE),
	    sarcoma =            if_else(str_detect(traits, "sarcoma"), TRUE, FALSE),
	    skin_or_melanoma =   if_else(str_detect(traits, "melanoma|skin|basal|keratinocyte|squamous"), TRUE, FALSE),
	    thyroid =            if_else(str_detect(traits, "thyroid"), TRUE, FALSE),
	    testicular =         if_else(str_detect(traits, "testic"), TRUE, FALSE),
	    cancer_unspecified = if_else(str_detect(traits, "^cancer"), TRUE, FALSE)
	) %>% 
    filter(!str_detect(traits, "body mass index")) # Remove 28044437 BMI change in cancer patients
```



```{r}
# Check whether any publications are not classified
cancer_classes %>% 
	filter(!any(c(bile_duct:cancer_unspecified)))

cancer_classes %>% 
    filter(
        bile_duct == FALSE,
        bladder == FALSE,
        blood == FALSE,
        brain == FALSE,
        breast == FALSE,
        cervical == FALSE,
        colorectal == FALSE,
        endometrial == FALSE,
        esophageal == FALSE,
        gallbladder == FALSE,
        gastric == FALSE,
        head_neck == FALSE,
        kidney == FALSE,
        liver == FALSE,
        lung == FALSE,
        lymphoma == FALSE,
        neuroblastoma == FALSE,
        ovarian == FALSE,
        pancreatic == FALSE,
        prostate == FALSE,
        sarcoma == FALSE,
        skin_or_melanoma == FALSE,
        thyroid == FALSE,
        testicular == FALSE,
        cancer_unspecified == FALSE,
    )
```


Sarcoma
Lymphoma
Kidney (renal)
Skin: BCC SCC Keratinocyte
Cancer Adenocarcinoma
Liver
```{r breast_pubs}
chemotherapy <- "anastrozole|taxane|paclitaxel|trastuzumab"
	# anastrozole - one publication:  30648747 (phamacokinetics/pharmacogenomics - SNP encodes anastrozole influx transporter)
	# taxane      - one publication:  29278617
	# paclitaxel  - two publications: 28763429, 24025145 (adverse effects: alopecia/change in LVEF)
	# trastuzumab - one publication:  28763429 (adverse effects: change in LVEF)

hormone_therapy <- "tamoxifen"    
	# tamoxifen   - two publications: 30161160, 22180457

radiation <- "childhood"
	# childhood   - one publication:  29059430 (studied effect of chest-directed radiotherapy on female survivors of childhood cancer

survival_time <- "free"
	# free        - two publications: 27758888, 25867717 (Cancer-free interval post treatment)

tumour_biochem <- "estrone|androstene"
	# estrone     - one publication:  28429243 (hormone levels in resected early-stage tumours)
	# androstene  - one publication:  28429243 

selected <- cancer_classes %>%
    filter(
        breast == TRUE,
        !str_detect(traits, "mortality"),          # exclude publications targeting post-diagnosis event (mortality)     - one publication:   30787463
        !str_detect(traits, chemotherapy),         # exclude publications targeting treatment response (chemotherapies)  - four publications: see exclusion terms
        !str_detect(traits, hormone_therapy),      # exclude publications targeting treatment response (hormone therapy) - two publications:  see exclusion terms
        !str_detect(traits, radiation),            # exclude publications targeting treatment exposure (radiation)       - one publication :  see exclusion terms
        !str_detect(traits, survival_time),        # exclude publications characterising recurrent disease               - two publications:  see exclusion terms
        !str_detect(traits, tumour_biochem),       # exclude publications characterising tumour environment              - one publication :  see exclusion terms
        !str_detect(traits, "survival"),           # exclude publications predicting post-diagnosis survival             - six publications:  29423119, 25964295, 25890600, 25867717, 25526632, 22232737
    )

rm(
    "chemotherapy",
    "hormone_therapy",
    "radiation",
    "survival_time",
    "tumour_biochem"
   )
```

```{r join prostate classified pubs to main dataset}
prognosis <- "aggressiveness|survival"
	# aggressiveness - one publication: 25939597
	# survival       - one publication: 26307654

treatment <- "treatment|docetaxel|radiotherapy"
	# treatment  - one publication: 20932654
 	# docetaxel  - one publication: 27143689
    # radiotherapy - three publications: 27515689, 24974847, 23376709

 selected <- cancer_classes %>% 
	filter(
	    prostate == TRUE,
	    !str_detect(traits, 'benign'),          # exclude publications targeting benign traits             - one publication:    30410027
	    !str_detect(traits, treatment),         # exclude publications targeting adverse treatment effects - five publications:    see exclusion terms
	    !str_detect(traits, prognosis),         # exclude publications targeting prognosis                 - two publications:   see exclusion terms
	) %>% 
    rbind(selected)

rm("prognosis",
   "treatment")

```

```{r join colorectal classified pubs to main dataset}
survival <- "metastasis|survival"
	# metastasis - one publication:    30738427
	# survival   - three publications: 26586795, 26222057, 25866641

selected <- cancer_classes %>% 
    filter(
        colorectal == TRUE,
        !str_detect(traits, survival),            # exclude publications targeting time to non-diagnosis event        - three publications: see exclusion terms
        !str_detect(traits, "toxicity"),          # exclude publications targeting adverse treatment response         - one publications:   30557370
        !str_detect(traits, "adenoma"),           # exclude publications targeting benign traits                      - one publication:    29228715
    ) %>% 
    rbind(selected)

rm("survival")
```

```{r join ovarian classified pubs to main dataset}
chemotherapy <- "carboplatin|paclitaxel"
	# carboplatin - three publications 29367611 (pharmacokinetics), 28935272 (progression-free survival), 28935272 (treatment response)
	# paclitaxel  - three publications 29367611 (pharmacokinetics), 28935272 (progression-free survival), 28935272 (treatment response)

selected <- cancer_classes %>%
	filter(
	    ovarian == TRUE,
	    !str_detect(traits, chemotherapy),        # exclude publications targeting treatment response         - one publication:  see exclusion list
	) %>% 
    rbind(selected)

rm("chemotherapy")
```

```{r join cervical classified pubs to main dataset}
selected <- cancer_classes %>% 
	filter(
	    cervical == TRUE,
	    !str_detect(traits, "chemotherapy"),        # exclude publications targeting treatment response - one publication: 28120872
	) %>% 
    rbind(selected)
```

```{r join blood classified pubs to main dataset}
selected <- cancer_classes %>% 
	filter(
	    blood == TRUE,
	    !str_detect(traits, "survival|infection|neuropathy"),        # exclude publications targeting myeloma-secondary event - three publications: 28120872, 29594489, 28317148
	) %>% 
    rbind(selected)
```

```{r join bile_duct classified pubs to main dataset}
selected <- cancer_classes %>% 
	filter(
	    bile_duct == TRUE,
	    !str_detect(traits, 'time to event')
	) %>% 
    rbind(selected)

```

```{r}
selected <- cancer_classes %>% 
	filter(
	    thyroid == TRUE,
 		!str_detect(traits, "radiation"), # exclude publications with additional exposure factors - one publication: 20350937
 	) %>% 
    rbind(selected)
```
# UP TO HERE
```{r}
selected <- cancer_classes %>% 
	filter(
	    bladder == TRUE,
 		!str_detect(traits, "smoking") # exclude publications on smoking interaction - one pub: 24662972
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>% 
	filter(
	    brain == TRUE,
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>% 
	filter(
	    endometrial == TRUE,
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>% 
	filter(
	    esophageal == TRUE,
	    !str_detect(traits, "interaction|survival")
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>%
	filter(
	    gallbladder == TRUE,
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>%
	filter(
	    gastric == TRUE,
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>%
	filter(
	    head_neck == TRUE,
 	) %>% 
    rbind(selected)
```

```{r select relevant liver pubs}
selected <- cancer_classes %>%
	filter(
	    liver == TRUE,
	    !str_detect(traits, "response|survival|hepatitis")
	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>%
	filter(
	    lung == TRUE,
	    !str_detect(traits, "smoker|interaction")
 	) %>% 
    rbind(selected)
```

```{r select relevant lymphoma pubs}
selected <- cancer_classes %>%
	filter(
	    lymphoma == TRUE,
	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>%
	filter(
	    neuroblastoma == TRUE,
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>%
	filter(
	    pancreatic == TRUE,
	    !str_detect(traits, "gemcitabine|survival")
 	) %>% 
    rbind(selected)
```

```{r}
selected <- cancer_classes %>%
	filter(
	    skin_or_melanoma == TRUE,
	    !str_detect(traits, "toxicity")
 	) %>% 
    rbind(selected)
```

```{r}
# selected <- 
cancer_classes %>%
	filter(
	    testicular == TRUE,
 	) %>% 
    rbind(selected)
```

```{r bind}
gwas_classified <- selected %>%
	right_join(gwas_cancer_data, by = "PUBMEDID") %>%
	mutate(
	    bile_duct = if_else(is.na(bile_duct), FALSE, bile_duct),
	    bladder = if_else(is.na(bladder), FALSE, bladder),
	    blood = if_else(is.na(blood), FALSE, blood),
	    brain = if_else(is.na(brain), FALSE, brain),
	    breast = if_else(is.na(breast), FALSE, breast),
	    cervical = if_else(is.na(cervical), FALSE, cervical),
	    colorectal = if_else(is.na(colorectal), FALSE, colorectal),
	    endometrial = if_else(is.na(endometrial), FALSE, endometrial),
	    esophageal = if_else(is.na(esophageal), FALSE, esophageal),
	    gallbladder = if_else(is.na(gallbladder), FALSE, gallbladder),
	    gastric = if_else(is.na(gastric), FALSE, gastric),
	    head_neck = if_else(is.na(head_neck), FALSE, head_neck),
	    lung = if_else(is.na(lung), FALSE, lung),
	    neuroblastoma = if_else(is.na(neuroblastoma), FALSE, neuroblastoma),
	    ovarian = if_else(is.na(ovarian), FALSE, ovarian),
	    pancreatic = if_else(is.na(pancreatic), FALSE, pancreatic),
	    prostate = if_else(is.na(prostate), FALSE, prostate),
	    skin_or_melanoma = if_else(is.na(skin_or_melanoma), FALSE, skin_or_melanoma),
	    thyroid = if_else(is.na(thyroid), FALSE, thyroid),
	    testicular = if_else(is.na(testicular), FALSE, testicular),
	) %>%
    distinct(PUBMEDID, SNPS, .keep_all = TRUE) %>% 
	arrange(PUBMEDID)
```



